# Organization

The instructions for generation of MOM6 documentation is divided into three sections.

* [Documentation process](#documentation-process)
* [Documentation syntax](#documentation-syntax)
* Software
  * [Installation](#software-installation)
  * [Operation](#software-operation)

# Terminology and abbreviations

To assist with writing of this documentation, we use several abbreviations.

**RST**: [reStructuredText](https://docutils.sourceforge.io/rst.html); a markdown language leveraged by sphinx via [docutils](https://docutils.sourceforge.io/).

**RTD**: [Read the Docs](https://readthedocs.org/)

# Documentation process

An API and user manual are the main forms of the MOM6 documentation produced.

*API Manual*

The API (reference) manual contains descriptions of all the modules, subroutines, functions, arguments and members that form data structures for variables.  This version of the html documentation is hosted here: [APIs](http://noaa-gfdl.github.io/MOM6/APIs/index.html)

This version of the manual utilizes the html output of doxygen.

*User Manual*

A user manual format of the manual contains more descriptive materials.  This version of the manual may also contain the APIs.  RTD is a popular hosting service for documentation.   A copy of the may be found here: [MOM6 User Manual](https://mom6.readthedocs.io/en/latest/).

Please see the software operation section for details on how to produce various portions of this documentation locally and on your own RTD site as desired.

## Overview

Source code with embedded documentation is processed by doxygen.

Doxygen in run in two modes.  For the API manual, it is instructed to generate only the html version of the documentation.  For the user manual, it is instructed to generate intermediate files for use with sphinx and RTD.  For purposes of this documentation the API manual is referred to as generated using html(doxygen).  The html generated by sphinx is referred to as html(sphinx).  The same references may be applied to the pdf versions: pdf(doxygen) and pdf(sphinx).

If the software is installed, local copies of html and pdf instead of those found at RTD.  The html and pdf versions produced by doxygen will not have any of the additional documentation from the sphinx portion of the pipeline.

## Starting structure

We define `SRC` as the root of the source directory assuming the `$(SRC)` directory was created from downloading the tree from github using `git clone`.

The starting state of directories and files:
```
SRC/
  config_src/
    coupled_driver
    dynamic
    dynamic_symmetric
    external
    ice_solo_driver
    mct_driver
    nuopc_driver
    solo_driver
    unit_drivers
  pkg/
    CVMix-src
    GSW-Fortran
  src/
    ALE
    core
    diagnostics
    equation_of_state
    framework
    ice_shelf
    initialization
    ocean_data_assim
    parameterizations
    tracer
    user
  docs/
    _static/
    _templates/
    *.rst
    api/*.rst
    images/*
    bin/doxygen
```

## Doxygen

The [Doxygen](http://www.doxygen.org/) package is used to scan the source code for embedded documentation.  Doxygen also automatically produces API documentation from arguments to subroutines, functions and member of types.  The guide for using doxygen in MOM6 is hosted on the [MOM6 developer's wiki](https://github.com/NOAA-GFDL/MOM6/wiki/Doxygen).

The majority of documentation is embedded in the comments of the source code.  Additional documents have been added in the form of doxygen files (`*.dox`).  The additional documents can be identified as those prefixed with an underscore (`_`) and have the `dox` extension.

The content of the additional documents and source code should conform to usage
as defined by the doxygen user and reference
[manuals](https://www.doxygen.nl/manual/index.html).  Further guidance is provided
on the [MOM6 developer's wiki](https://github.com/NOAA-GFDL/MOM6/wiki/Doxygen).

For the API documentation, the tree will look like this:
```
SRC/
  docs/
    _build/
      doxygen_warn_rtd_log.txt
      [html|latex]
        _static
    MOM6.tags
```

The main driver for doxygen is a configuration file.  The content linked to [MOM6 developer's wiki](https://github.com/NOAA-GFDL/MOM6/wiki/Doxygen) uses the `Doxyfile_nortd` configuration file.

By default, the html directory is only available after processing the documentation.  Please see [software operation](software-operation) on how to generate the pdf companion of the documentation.

For the user manual documentation run, this is the first phase of the process.  This process produces the following directories and files:
```
SRC/
  docs/
    _build/
      doxygen_warn_rtd_log.txt
    xml/
    MOM6.tags
```

The documentation generated by Sphinx and RTD uses the `Doxyfile_rtd`.  These options can be overridden at the command line.  See software operation for more details.

The `_build/doxygen_warn_rtd_log.txt` should be reviewed for warnings and errors.

## Sphinx

The [Sphinx](https://www.sphinx-doc.org/) package renders final versions of html and pdf documents.  The provided RST files (`*.rst`) provide the organization structure for the html and pdf documents.  It is recommended that any significant content be pushed into the source code or additional dox files.

During a complete documentation run, this is the second phase of the process.  Files and directories created:
```
SRC/
  docs/
    _build/
      html_log.txt
      doctrees
      [html|latex]
```

The directories, html and or latex, will be present depending on how Sphinx was called.  The `doctrees` directory contains processed documents saved as python pickles (binary data structures).

The `html_log.txt` should be reviewed for warnings and errors.

## Read the Docs

The RTD site can be configured to watch for updates on a github repository.  A documentation update may be triggered when an update is pushed to the repository.  The entire documentation process is run twice.  The first run produces html.  The second run produces a pdf.

NOTE: There is a rough execution time limit of about 900 seconds.  Trying to do more than that will cause a "timeout" error.

# Documentation syntax

This section will highlight some common special cases to the documentation syntax not found in the user manuals for Doxygen or Sphinx.  Please
refer to the user manual for documentation syntax.

## Doxygen

Doxygen user and reference [manuals](https://www.doxygen.nl/manual/index.html) should be consulted for general syntax for embedding documentation in source code and `*.dox` files.  An additional style guide when applying doxygen syntax can be found [here](https://github.com/NOAA-GFDL/MOM6/wiki/Doxygen).  A [troubleshooting](#troubleshooting) guide is provided with most commonly reported problems.

NOTE: Not all doxygen commands are supported through the sphinx documentation processor.  Support can be added by adding an [issue](https://github.com/NOAA-GFDL/MOM6/issues) to the github repository.

### Equation References

*Syntax:* `\eqref{tag}`

A [custom command](https://www.doxygen.nl/manual/custcmd.html) is created to process the tag for use in latex and html.  For latex, `\eqref` is intercepted and changed to `\ref`.  For html, it is unchanged and intercepted by [MathJax](#mathjax).

**Why?** For latex, all references to equations use the `\ref` tag.  For MathJax, once the html page is loaded, the javascript hunts for `\eqref` tags and replaces them with links to equations.

### Complicated Equation References

These refer to multi-line named equations that need to be referred to from other html pages.  If you do not need to link to these
equations from other html pages, then you do not need to use this custom command.  You can use the `\eqref{tag}` instead.

*Syntax:* `\eqref{tagA,tagB,tagC}`

Large formulas with column formatting using `&` generally are wrapped in a `\f{eqnarray}`:
```
\f{eqnarray}
\label{html:ale-equations} \\
h^\dagger &= h^{(n)} - \Delta t \left[ \nabla_r \cdot \left( h \, \mathbf{u} \right) \right]
&\mbox{thickness} \label{eq:ale-thickness-equation} \\
\theta^\dagger \, h^\dagger &= \theta^{(n)} \, h^{(n)} - \Delta t \left[ \nabla_r \cdot \left( \theta h \, \mathbf{u} \right) - h \boldsymbol{\mathcal{N}}_\theta^\gamma + \delta_r J_\theta^{(z)} \right]
&\;\;\;\;\mbox{potential temp} \label{eq:ale-temperature-equation} \\
h^{(n+1)} &= h^\dagger - \Delta t \, \delta_r \left( z_r \dot{r} \right)
&\mbox{move grid} \label{eq:ale-new-grid} \\
\theta^{(n+1)} h^{(n+1)} &= \theta^\dagger h^\dagger - \Delta t \, \delta_r \left( z_r \dot{r} \, \theta^\dagger  \right)
&\mbox{remap temperature.} \label{eq:ale-remap-temperature}
\f}
```

A *special* label is added right after the `\f{eqnarray}` opening.  This helps produce an implicit label and allows the formula to be linked to from external pages.  Notice that each line of the formula has its own `\mbox` and `\label`.   The combination of the html link and the mbox and label tags form the arguments to the `\eqref` command.

To create a reference link to the first line of the formula, you would use:
`\eqref{eq:ale-thickness-equation,ale-equations,thickness}`.  For latex, this is translated into `\ref{eq:ale-thickness-equation}` and all the references work out as usual.  For html, the second argument should match the special label placed after the opening `\f{eqnarray}`.  The allows generation of a html link back to the entire formula block.  The last argument informs the reader which line of the formula is of interest.

**Why?** MathJax is unable to maintain a list of formula references that span multiple html pages. Restructured text also only supports one label per large `:math:` block.  Restructured text cannot uniquely number equations across pages.

**Sphinx**: NOTE: In the example above, the reference `ale-equations` is translated by sphinx into `equation-ale-equations`.  The prefix `equation-` is added to the tag used for this purpose.

NOTE: A post-processor, `postProcessEquations.py` has been written to renumber equations for sphinx and doxygen generated html.

### Footnotes

*Syntax:* `\footnote{text}`

The footnote command is split between latex and html.  For latex, it is passed through unchanged and latex generates footnotes appropriately.  For html(doxygen), a superscript `[*]` is created with a title attrbute equalling the text.  For html(sphinx), the footnote is translated into footnote RST syntax.  Footnotes are automatically numbered and numbering is restarted for individual pages.

NOTE: Currently the footnote text is not processed.  Any embedded citations currently do not function properly for html(doxygen).  They were recently fixed in html(sphinx) and pdf(sphinx).

## Sphinx

## MathJax

The `\mathbold` command is not supported.  See [troubleshooting](#troubleshooting) for common problems with MathJax.

## Troubleshooting

### Doxygen

#### Commands

*anchor*
- To add a label to a figure, the `\anchor` should appear just prior to the image, figure or text you want to link to.  If you
add an anchor prior to a paragraph, it has a side effect of making it a block paragraph.

*image*
- The text associated with an `\image` command should not have any line breaks.  The text or caption must be surrounded in quotes
which are stripped prior to publication.  A fourth optional argument may be used to control width or height of the image.
See doxygen [image](https://www.doxygen.nl/manual/commands.html#cmdimage) command.  See [image example](details#Images) for a detailed example of usage.

#### Tables

To reference tables, be sure the `id=` argument is in quotes.  Example:

```
<caption id="scale_factors">
```

A reference to this table is now possible using `\ref scale_factors`.

#### Arguments

This snippet will not properly document the MEKE argument.
```
!> Integrates forward-in-time the MEKE eddy energy equation.
!! See \ref section_MEKE_equations
subroutine step_forward_MEKE(MEKE, h, visc, dt, G, CS)
type(MEKE_type),                       pointer       :: MEKE !< MEKE
```

**This is better**
```
type(MEKE_type),                       pointer       :: MEKE !< MEKE data
```

### Latex math

Good locations to test equations for both latex and MathJax:
- [LaTex Base](https://latexbase.com/)
- [MathJax](https://www.mathjax.org/#demo)

*eqnarray*
- Use of `\mbox{}` requires surrounding braces as in {\mbox{}}
- If a formula needs formatting using `&` you must use eqnarray
- MathJax does not handle backslashes (`\`) within `\mbox{}`
  - Wrong (ok in latex): `\mbox{nonpen\_SW}`
  - Correct: `\mbox{nonpen}\_\mbox{SW}`

*formula*
- Math elements within `\mbox{}` requires `$` escaping

#### Equation references and formatting

MathJax is only able to number equations on a single page.  It is unable to keep track of numbering across multiple pages like latex.  A little bit of tickery involved to maintain links across html pages as produced by sphinx.  A post processor will need to be written for html generated by doxygen.  In general, this method of documentation is only needed if formulas need to be referenced from external pages and the formulas require `&` for alignment.

Single equations that need to be referenced from other pages should utilize the doxygen `\anchor` command.

# Software operation

The entire documentation processing pipeline can be operated using the provided `Makefile`.  Running `make` or `make help` will provide some helpful information.

Otherwise, savvy users can run individual pieces on the command line using provided configuration files.

Certain environment variables may be set prior or during the `make` command to influence the documentation build process.  Explanations on how to run various parts of the pipeline are given below.

## Doxygen

For generation of the API portion of the documentation, see the [MOM6 developer's wiki](https://github.com/NOAA-GFDL/MOM6/wiki/Doxygen#generating-html-with-doxygen).

The configuration file used for doxygen is `Doxyfile_nortd`.

From the `Makefile`, the API portion of the pipeline may be run using:
`make nortd`

NOTE: `make nortd` will attempt to install doxygen if it is not found.

## Sphinx

The full documentation can be generated locally with
```bash
# NOTE: make sure _build directory exists
make html >& _build/html_log.txt
```
which will generate html in `docs/_build/html/`. Start at `docs/_build/html/index.html`. This will also place log information
into the `_build` tree that is viewable.  Warning messages from doxygen is written to `_build/doxygen_warn_rtd_log.txt`.

To fix equation targets and references the full update to the RTD/Sphinx documentation requires:
```bash
make html UPDATEHTMLEQS=Y
```

### Options

Many options can be passed to sphinx with make on the command line after the last argument.  e.g. `make html SPHINXOPTS=-v`

Multiple arguments may be passed using a space as separation between arguments.

#### Makefile

Useful combinations:
* make clean (Cleans the working directory of most intermediate and final documentation)
* make Clean (Removes the `_build` and `xml` directory and MOM6.tags file)
* make html (Builds html based documentation)
* make latex (Builds latex based documentation; does not compile a pdf)
* make latexpdf (Attempts to build a final pdf of the documentation)

Run `make` or `make help` for other options.

The doxygen generated HTML can be obtained locally (and slightly more quickly) with
```bash
make nortd SPHINXBUILD=false
```
which will generate html in `docs/APIs/`. Start at `docs/APIs/index.html`. If doxygen is not already available this will install a
local copy of doxygen.

##### SPHINXOPTS

This option is passed to `sphinx-build`.  See `sphinx-build --help` for more information.

##### BUILDDIR

The default output directory is `_build`.  The default doxygen configuration files are expecting an output
directory of `_build`.

##### UPDATEHTMLEQS

If this option is set to `Y`, `postProcessEquations.py` will be run to attempt to update equation numbers in the generated html.

If `UPDATEHTMLEQSVERBOSE` is set to `-v` this will turn on verbose printing for the post processor.

##### PAPER

The default value is empty (`PAPER=`).  There are two options currently available in the Makefile (a4 or letter).

#### conf.py

Other options are read by `conf.py` and can be passed on the command line when running make.  These options may
also be set in the shell environment prior to running make.  These can be set on RTD too.

##### DOXYGEN_BIN

Using this option, you can specify a different doxygen binary for processing the documentation.  Otherwise, a
doxygen executable needs to be available in the system path.

##### DOXYGEN_CONF

Use this option to specify a custom configuration file to doxygen.

##### DOXYGEN_API

Setting this variable will cause doxygen to run the `Doxyfile_nortd` configuration file.  This will attempt to
compile the `APIs` html version of the MOM6 documentation and add it to the RTD output.  The default location is
the `APIs` directory.

NOTE: Do not run both API and APIPDF.  RTD will not have sufficient time to complete the job.

##### DOXYGEN_APIPDF

Setting this variable will cause doxygen to run the `Doxyfile_nortd` configuration file.  This will attempt to
compile the `APIs` pdf version of the MOM6 documentation and add it to the RTD output.  The default location of the
resultant PDF is `APIs/latex/refman.pdf`.

NOTE: This option will generate the html and PDF versions of the APIs.

##### NCAR_FORK

This option activates the NCAR configuration file: `ncar/Doxyfile_ncar_rtd`

### Local web server

Python provides a way to quickly stand up a private web server for checking documentation. It requires knowledge of
the IP address if you are using a remote server, otherwise `localhost` should work.

You can start the server on any port. Port 8080 is shown here as an example.
```bash
python3 -m http.server 8080
```

After starting the server, you can browse to the known IP using `http://IP/` or if you are on the same
machine use `http://localhost/`.

# Software installation

On a relatively bare system, you can install a fairly stable documentation pipeline.

## Dependencies

If you do not have doxygen, to build a local version of the doxygen processor you will need the following packages:
- cmake
- g++ (or a c++ compiler)
- flex
- bison
- graphviz
- pdf2svg

(e.g. `apt-get install cmake g++ flex bison graphviz`)

If you are building the full generated sphinx documentation you will need the following packages in addition to those for doxygen above:
- libxml2-dev
- libxslt-dev (may also be called libxslt1-dev)

(e.g. `apt-get install libxml2-dev libxslt-dev`)

We strongly recommend using `python3` with its virtual environment and `pip3`.

(e.g. `apt-get install python3 python3-venv python3-pip`)

Before running sphinx (`make html`) you will need to issue:

```bash
pip install -r requirements.txt
```

You may need to use `pip3` to install requirements for python3.

Requirements:
- sphinx
- sphinx-rtd-theme
- sphinx-bibtex
- sphinx-fortran
- sphinxcontrib\_autodox-doxygen
- flint
- lxml
- numpy
- future

For machines that need to build future, numpy or lxml, these packages are required:
- Cython
- wheel

### Latex/PDF generation

PDF generation requires the following packages
- texlive-latex-base
- texlive-latex-recommended
- texlive-latex-extra
- latexmk

### doxygen

Download latest [source](https://www.doxygen.nl/download.html).  Latest is `doxygen-1.8.19.src.tar.gz`.

```bash
tar xzf doxygen-1.8.19.src.tar.gz
cd doxygen-1.8.19
mkdir build
cd build
cmake -G "Unix Makefiles" ..
make
sudo make install
```

Make install attempts to place the compiled version into /usr/local/bin.  You can link to a
specific executable within the virtual environment.   At this point we also recommend
renaming `doxygen` to `doxygen-1.8.19` within `/usr/local/bin`.

### Read the Docs

The [Read the Docs](https://readthedocs.org/) (RTD) site uses a virtual machine (VM) for processing documentation.  The VM is of
os architecture type x86\_64.  A doxygen binary can be compiled and included in our git repo
for use in RTD.  The defualt doxygen in use is 1.8.13 which produces XML that does not work for our use.  We
supply a compiled binary version 1.8.19 that provide better XML.  However, there are still some shortcomings.

NOTE: Using modified python modules on RTD is possible through careful crafting of the requirements.txt file.  It is impossible to replace system binaries or compile code on RTD.  It is possible to ship replacement binaries that can be run from the repo.

#### Logfiles

See Sphinx run options below.  We capture up to three logfiles for RTD.  The main default logfile is `LOGS/doxygen_warn_rtd_log.txt`.  If the API or APIPDF runs are enabled, then `doxygen_warn_nortd_log.txt` or `doxygen_warn_nortd_latex_log.txt` may also be available.

Logfiles were renamed to `*.txt` to allow easier access and viewing from most websites.
Most websites force download of `*.log` files.

### python3 virtual enviroment

Setup a virtual environment for processing:

```bash
python3 -m venv venv/mom6Doc
source venv/mom6Doc/bin/activate
# cd to the docs directory within the MOM6 repo
pip3 install -r requirements.txt
```

The `deactivate` command allows you to exit from the virtual environment.

NOTE: RTD will not upgrade the sphinx module if `#egg=` is specified in the `requirements.txt` file.

### debugging

A useful commnad line tool for debugging sphinx and extensions is the python debugger.
Add the following line to stop to any portion of the python code to create a break
point.

```python
import pdb; pdb.set_trace()
```

Run `make html` without redirection to a log file.

For only processing .dox files, run
`make clean; make html DOXYGEN_CONF=Doxyfile_rtd_dox UPDATEHTMLEQS=Y`

## Example execution

The following example assumes a virtual environment as setup above using `mom6Doc`.
The same environment is possible using anaconda.

```
$ source venv/mom6Doc/bin/activate
(mom6Doc) $ cd docs
(mom6Doc) $ make clean
(mom6Doc) $ make html >& _build/html_log.txt
(mom6Doc) $ make latexpdf >& _build/latex_log.txt
```

The last command may appear to hang.  On error, latex will request input from the keyboard.
Press `R` and enter.  This will keep latex running to completion or stop after 100 errors
are reached.

Once the documentation is built, you can use a web browser to look around in the `_build`
directory.

# Credits

## 2020
The documentation pipeline was upgraded by [Rob Cermak](https://github.com/jr3cermak) and [Marshall Ward](https://github.com/marshallward).  Four modified python modules are required
to process the MOM6 documentation.  The versions are tagged and placed into the production version of `requirements.txt`.  Development versions may be found in the respective `dev` branches.

| Source | Modified | Version | Development |
| ------ | -------- | ------- | ----------- |
| [sphinx](https://github.com/sphinx-doc/sphinx) | [sphinx-3.2.1mom6.1](https://github.com/jr3cermak/sphinx) | B:3.2.1mom6.2 | B:dev |
| [sphinxcontrib-autodoc-doxygen](https://github.com/rmcgibbo/sphinxcontrib-autodoc_doxygen) | [sphinxcontrib-autodoc-doxygen](https://github.com/jr3cermak/sphinxcontrib-autodoc_doxygen) | T:0.7.8 | B:dev |
| [sphinx-fortran](https://github.com/VACUMM/sphinx-fortran) | [sphinx-fortran](https://github.com/jr3cermak/sphinx-fortran) | T:1.2.1 | B:dev |
| [flint](https://github.com/marshallward/flint) | [flint](https://github.com/jr3cermak/flint) | T:0.0.1 | B:dev |
| [MOM6](https://github.com/NOAA-GFDL/MOM6) | [esmg-docs](https://github.com/ESMG/MOM6/tree/esmg-docs) | [esmg-docs](https://github.com/jr3cermak/MOM6/tree/esmg-docs) | B:[dev/rob](https://github.com/jr3cermak/MOM6/tree/dev-rob) |

T: tag B: branch

## 2017
The sphinx documentation of MOM6 is made possible by modifications by [Angus Gibson](https://github.com/angus-g) to two packages, [sphinx-fortran](https://github.com/angus-g/sphinx-fortran) and [autodoc\_doxygen](https://github.com/angus-g/sphinxcontrib-autodoc_doxygen).
