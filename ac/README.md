# Autoconf Build Configuration

This directory contains the configuration files required to build MOM6 using
autoconf.

Note that a top-level `./configure` is not contained in the repository, and the
instruction below will generate this script in the `ac` directory.


# Requirements

The following tools and libraries must be installed on your system.

* autoconf
* Fortran compiler (e.g. gfortran)
* MPI (e.g. Open MPI, MPICH)
* netCDF, with Fortran support

On some platforms, such as macOS, the autoconf package may also require an
installation of automake.

Some packages such as netCDF may require an additional packages for Fortran
support.


# Quick start guide

The following instructions will allow a new user to quickly create a MOM6
executable for ocean-only simulations.

A separate Makefile in `ac/deps/` is provided to gather and build any GFDL
dependencies.
```
cd ac/deps
make -j
```
This will fetch the `mkmf` tool and build the `libFMS` library.

To build MOM6, first generate the autconf `configure` script.
```
cd ac
autoreconf
```
Then select your build directory, e.g. `./build`, run the configure script, and
build the model.
```
mkdir -p build
cd build
../ac/configure
make -j
```
This will create the MOM6 executable in the build directory.

This executable is only useable for ocean-only simulations, and still requires
the necessary experiment configuration files, such as `input.nml` and
`MOM_input`.  For more information, consult the
[MOM6-examples wiki](https://github.com/NOAA-GFDL/MOM6-examples/wiki).


# Build rules

The Makefile produced by autoconf provides the following rules.

``make``

  Build the MOM6 executable.

``make clean``

  Delete the executable and any object and module files, but preserve the
  autoconf output.

``make distclean``

  Delete all of the files above, as well as any files generated by
  `./configure`.  Note that this will delete the Makefile containing this rule.

``make ac-clean``

  Delete all of the files above, including `./configure` and any other files
  created by `autoconf`.  As with `make distclean`, this will also delete the
  Makefile containing this rule.


# Build configuration settings

Autoconf will resolve most model depenencies, and includes the standard set
of configuration options, such as `FC` or `FCFLAGS`.  The MOM6-specific 
`configure` script settings are described below.

`--enable-asymmetric`
  
  The MOM6 executable is configured to use symmetric grids by default.

  Use the flag above to compile using uniform asymmetric grids.

  Symmetric grids are defined such that the fields for every C-grid cell are 
  fully specified by their local values.  In particular, quantities such as 
  velocities or vorticity will be defined along the boundaries of the domain.

  Use of symmetric grids simplifies calculations, but also results in
  nonuniform domain sizes for different fields, and slightly greater storage
  since the additional values can be considered redundant.

`--enable-openmp`

  Use this flag to enable OpenMP in the build.

`--disable-real-8`

  While MOM6 does not explicitly use double-precision reals, most of the
  algorithms are designed and tested under this assumption.

  This flag may be used to disable these flags, causing the compiler to use the
  default size (usually single-precision), although there is no guarantee that
  the model will be useable.

For the complete list of settings, run `./configure --help`.


# GFDL Dependencies

This section briefly describes the management of GFDL dependencies `mkmf` and
FMS.

The `configure` script will first check if the compiler flags (`FCFLAGS`,
`LDFLAGS`, etc.) can find `mkmf` and the FMS library.  If unavailable, then it
will search in the local `ac/deps` library.  If still unavailable, because it
has not yet been built, then the build will abort.

Running `make -C ac/deps` will ensure that the libraries are available.  But if
the user wishes to target an external FMS library, then they should add the 
appropriate `FCFLAGS` and `LDFLAGS` to find the library.

Similar options are provided for `mkmf` with respect to `PATH`, although it
is usually not necessary to use an external `mkmf` script.

Some configuration options are provided by the `ac/deps` Makefile:

`PATH_ENV`

  This variable will override the value of `PATH` when building the dependencies.

`FCFLAGS_ENV`

  Used to override the default autoconf flags, `-g -O2`.  This is useful if,
  for example, one wants to build with `-O0` to speed up the build time.

`MKMF_URL` (*default:* https://github.com/NOAA-GFDL/mkmf.git)
`MKMF_COMMIT`(*default:* `master`)
`FMS_URL` (*default:* https://github.com/NOAA-GFDL/FMS.git)
`FMS_COMMIT` (*default:* `2019.01.03`)
  
    These are used to specify where to check out the source code for each 
    respective project.


# Known issues / Future development

## MPI configuration

There are minor issues with the MPI configuration macro, where it may locate an
MPI launcher based on a compiler which does not match the corresponding
compiler, `FC`, which will tend to default to GFortran.

This is usually not an issue, but can cause confusion when the `FCFLAGS` were
configured for the launcher but do not work with `FC`, whose value is only used
in the initial `configure` testing.

To resolve this, ensure that `FC` and `FCFLAGS` are specified for the same
compiler.

## Coupled builds

The autoconf build is currently only capable of building ocean-only
executables, and cannot yet be build as a standalone library.  This is planned
to be addressed in a future release.
